<?xml version="1.0" encoding="UTF-8" ?> 

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.activiti.engine.impl.persistence.entity.ExecutionEntity">

	<!-- Process Search -->
	<select id="customSelectProcessInstanceByQueryCriteria"
			parameterType="net.emforge.activiti.query.CustomProcessInstanceQueryImpl"
			resultMap="org.activiti.engine.impl.persistence.entity.ExecutionEntity.processInstanceResultMap">
		${limitBefore}
		select distinct RES.* ${limitBetween}, P.KEY_ as ProcessDefinitionKey, P.ID_ as ProcessDefinitionId, P.NAME_ as ProcessDefinitionName, P.VERSION_ as ProcessDefinitionVersion, P.DEPLOYMENT_ID_ as DeploymentId
		<include refid="customSelectExecutionsByQueryCriteriaSql" />
		${orderBy}
		${limitAfter}
	</select>
	
	<select id="customSelectProcessInstanceCountByQueryCriteria"
			parameterType="net.emforge.activiti.query.CustomProcessInstanceQueryImpl"
			resultType="long">
		select distinct count(RES.ID_)
		<include refid="customSelectExecutionsByQueryCriteriaSql"/>
	</select>
	
	<sql id="customSelectExecutionsByQueryCriteriaSql">
		from ${prefix}ACT_RU_EXECUTION RES
		inner join ${prefix}ACT_RE_PROCDEF P on RES.PROC_DEF_ID_ = P.ID_
		<include refid="customCommonSelectExecutionsByQueryCriteriaSql" />
	</sql>
	

  <select id="customSelectProcessInstanceWithVariablesByQueryCriteria"
		parameterType="net.emforge.activiti.query.CustomProcessInstanceQueryImpl"
		resultMap="org.activiti.engine.impl.persistence.entity.ExecutionEntity.processInstanceAndVariablesResultMap">
    ${limitBefore}
    select distinct RES.*, P.KEY_ as ProcessDefinitionKey, P.ID_ as ProcessDefinitionId, P.NAME_ as ProcessDefinitionName, P.VERSION_ as ProcessDefinitionVersion, P.DEPLOYMENT_ID_ as DeploymentId, 
    VAR.ID_ as VAR_ID_, VAR.NAME_ as VAR_NAME_, VAR.TYPE_ as VAR_TYPE_, VAR.REV_ as VAR_REV_,
    VAR.PROC_INST_ID_ as VAR_PROC_INST_ID_, VAR.EXECUTION_ID_ as VAR_EXECUTION_ID_, VAR.TASK_ID_ as VAR_TASK_ID_,
    VAR.BYTEARRAY_ID_ as VAR_BYTEARRAY_ID_, VAR.DOUBLE_ as VAR_DOUBLE_, 
    VAR.TEXT_ as VAR_TEXT_, VAR.TEXT2_ as VAR_TEXT2_, VAR.LONG_ as VAR_LONG_
    ${limitBetween}
    <include refid="customSelectProcessInstanceWithVariablesByQueryCriteriaSql"/> 
    ${orderBy}
    ${limitAfter}
  </select>
  	
  <sql id="customSelectProcessInstanceWithVariablesByQueryCriteriaSql">  
    from ${prefix}ACT_RU_EXECUTION RES
    inner join ${prefix}ACT_RE_PROCDEF P on RES.PROC_DEF_ID_ = P.ID_
    <if test="includeProcessVariables">
      left outer join ${prefix}ACT_RU_VARIABLE VAR ON RES.PROC_INST_ID_ = VAR.EXECUTION_ID_ and VAR.TASK_ID_ is null
    </if>
    <include refid="customCommonSelectExecutionsByQueryCriteriaSql"/>
  </sql>
  	
  <sql id="customCommonSelectExecutionsByQueryCriteriaSql">
      <include refid="org.activiti.engine.impl.persistence.entity.ExecutionEntity.commonSelectExecutionsByQueryCriteriaSqlJoin"/>
      <include refid="customCommonSelectExecutionsByQueryCriteriaSqlJoin"/>
      <trim prefix="WHERE" prefixOverrides="WHERE |AND |OR |WHERE\n|AND\n|OR\n|WHERE\r|AND\r|OR\r|WHERE\t|AND\t|OR\t">
        <include refid="org.activiti.engine.impl.persistence.entity.ExecutionEntity.commonSelectExecutionsByQueryCriteriaSqlWhere"/>
        <include refid="customCommonSelectExecutionsByQueryCriteriaSqlWhere"/>
      </trim>
  </sql>

  <!-- Problem with cast - MySQL support only signed and unsigned as type for casting numbers, others not supporting them.
  		It is why we should  cast to char even it is not so good in performance case  -->
  <sql id="customCommonSelectExecutionsByQueryCriteriaSqlJoin">
  	<if test="userId != null || entryClassNameId != null || entryClassNameIds != null || entryClassPK != null">
  		inner join WorkflowInstanceLink W on RES.ID_ = cast(W.workflowInstanceId as char(256))
    </if>
  </sql>

  <sql id="customCommonSelectExecutionsByQueryCriteriaSqlWhere">
    <if test="processDefinitionVersion != null">
      and P.VERSION_ = #{processDefinitionVersion}
    </if>
    <if test="processDefinitionVersion == null &amp;&amp; processDefinitionLatestVersion">
        and P.VERSION_ = (select max(VERSION_) from ${prefix}ACT_RE_PROCDEF where KEY_ = P.KEY_)
    </if>
    <if test="userId != null">
    	and W.USERID = #{userId}
    </if>
    <if test="entryClassNameId != null">
    	and W.CLASSNAMEID = #{entryClassNameId}
    </if>
    <if test="entryClassNameIds != null">
    	and W.CLASSNAMEID IN
    	<foreach item="entryClassNameIdItem" collection="entryClassNameIds" index="index" open="("
			separator="," close=")">
			#{entryClassNameIdItem}
    	</foreach>
    </if>
    <if test="entryClassPK != null">
    	and W.CLASSPK = #{entryClassPK}
    </if>
  </sql>

</mapper>